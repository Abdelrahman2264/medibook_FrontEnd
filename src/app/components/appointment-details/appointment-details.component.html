<div class="appointment-details-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin fa-3x"></i>
      <p>Loading appointment details...</p>
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading && !appointment" class="error-container">
    <div class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Error Loading Appointment</h3>
      <p>{{ errorMessage }}</p>
      <button class="btn btn-primary" (click)="loadAppointmentDetails()">
        <i class="fas fa-redo"></i> Try Again
      </button>
      <button class="btn btn-secondary" (click)="goBack()">
        <i class="fas fa-arrow-left"></i> Back to Appointments
      </button>
    </div>
  </div>

  <!-- Appointment Details Content -->
  <div *ngIf="appointment && !isLoading" class="details-content">
    <!-- Header Section -->
    <div class="page-header">
      <button class="back-btn" (click)="goBack()">
        <i class="fas fa-arrow-left"></i> Back to Appointments
      </button>
      <div class="header-title">
        <h1>Appointment Details</h1>
        <p>Appointment ID: #{{ appointment.appointmentId }}</p>
      </div>
      <div class="header-actions">
        <button 
          *ngIf="(appointment.status === 'In Progress' || appointment.status === 'Assigned') && appointment.nurseId && appointment.roomId"
          class="btn-close-appointment" 
          (click)="confirmClose()">
          <i class="fas fa-check-circle"></i> Close Appointment
        </button>
      </div>
    </div>

    <!-- Status Badge -->
    <div class="status-section">
      <div class="status-badge" [style.background-color]="appointment.statusColor">
        <i [class]="appointment.statusIcon"></i>
        {{ appointment.status }}
      </div>
    </div>

    <!-- Main Content Grid - 2 Cards Per Row -->
    <div class="cards-flex">
        
        <!-- Patient Information Card -->
        <div class="info-card" *ngIf="patient">
          <div class="card-header">
            <h2><i class="fas fa-user-injured"></i> Patient Information</h2>
          </div>
          <div class="card-body row">
            <div class="profile-image-section" *ngIf="patient.profileImage">
              <img [src]="patient.profileImage" [alt]="patient.fullName" class="profile-image" />
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-user"></i> Patient Name</label>
              <p>{{ patient.fullName }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-id-card"></i> Patient ID</label>
              <p>#{{ patient.id }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-envelope"></i> Email</label>
              <p>{{ patient.email }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-phone"></i> Mobile Phone</label>
              <p>{{ patient.mobilePhone }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-venus-mars"></i> Gender</label>
              <p>{{ patient.gender }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="patient.mitrialStatus">
              <label><i class="fas fa-heart"></i> Marital Status</label>
              <p>{{ patient.mitrialStatus }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="patient.dateOfBirth">
              <label><i class="fas fa-birthday-cake"></i> Date of Birth</label>
              <p>{{ formatDate(patient.dateOfBirth) }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="patient.age">
              <label><i class="fas fa-calendar"></i> Age</label>
              <p>{{ patient.age }} years</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-circle"></i> Status</label>
              <p [class]="patient.isActive ? 'status-active' : 'status-inactive'">
                {{ patient.isActive ? 'Active' : 'Inactive' }}
              </p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="patient.createDate">
              <label><i class="fas fa-calendar-plus"></i> Created Date</label>
              <p>{{ formatDate(patient.createDate) }}</p>
            </div>
          </div>
        </div>
        <!-- Doctor Information Card -->
        <div class="info-card" *ngIf="doctor">
          <div class="card-header">
            <h2><i class="fas fa-user-md"></i> Doctor Information</h2>
          </div>
          <div class="card-body row">
            <div class="profile-image-section" *ngIf="doctor.photoUrl">
              <img [src]="doctor.photoUrl" [alt]="doctor.fullName" class="profile-image" />
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-user"></i> Doctor Name</label>
              <p>Dr. {{ doctor.fullName }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-id-card"></i> Doctor ID</label>
              <p>#{{ doctor.doctorId }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-stethoscope"></i> Specialization</label>
              <p>{{ doctor.specialization }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-briefcase"></i> Type</label>
              <p>{{ doctor.type }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-award"></i> Experience</label>
              <p>{{ doctor.experienceYears }} years</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-envelope"></i> Email</label>
              <p>{{ doctor.email }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-phone"></i> Mobile Phone</label>
              <p>{{ doctor.mobilePhone }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-venus-mars"></i> Gender</label>
              <p>{{ doctor.gender }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="doctor.dateOfBirth">
              <label><i class="fas fa-birthday-cake"></i> Date of Birth</label>
              <p>{{ formatDate(doctor.dateOfBirth) }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="doctor.bio">
              <label><i class="fas fa-file-alt"></i> Biography</label>
              <p class="bio-text">{{ doctor.bio }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-circle"></i> Status</label>
              <p [class]="doctor.isActive ? 'status-active' : 'status-inactive'">
                {{ doctor.isActive ? 'Active' : 'Inactive' }}
              </p>
            </div>
          </div>
        </div>

        <!-- Nurse Information Card -->
        <div class="info-card" *ngIf="nurse">
          <div class="card-header">
            <h2><i class="fas fa-user-nurse"></i> Nurse Information</h2>
          </div>
          <div class="card-body row">
            <div class="profile-image-section" *ngIf="nurse.photoUrl">
              <img [src]="nurse.photoUrl" [alt]="nurse.fullName" class="profile-image" />
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-user"></i> Nurse Name</label>
              <p>{{ nurse.fullName }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-id-card"></i> Nurse ID</label>
              <p>#{{ nurse.nurseId }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-envelope"></i> Email</label>
              <p>{{ nurse.email }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-phone"></i> Mobile Phone</label>
              <p>{{ nurse.mobilePhone }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-venus-mars"></i> Gender</label>
              <p>{{ nurse.gender }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="nurse.dateOfBirth">
              <label><i class="fas fa-birthday-cake"></i> Date of Birth</label>
              <p>{{ formatDate(nurse.dateOfBirth) }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="nurse.bio">
              <label><i class="fas fa-file-alt"></i> Biography</label>
              <p class="bio-text">{{ nurse.bio }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-circle"></i> Status</label>
              <p [class]="nurse.isActive ? 'status-active' : 'status-inactive'">
                {{ nurse.isActive ? 'Active' : 'Inactive' }}
              </p>
            </div>
          </div>
        </div>

        <!-- Room Information Card -->
        <div class="info-card" *ngIf="room">
          <div class="card-header">
            <h2><i class="fas fa-door-open"></i> Room Information</h2>
          </div>
          <div class="card-body row">
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-door-open"></i> Room Name</label>
              <p>{{ room.roomName }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-id-card"></i> Room ID</label>
              <p>#{{ room.roomId }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-tag"></i> Room Type</label>
              <p>{{ room.roomType }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-circle"></i> Status</label>
              <p [class]="room.isActive ? 'status-active' : 'status-inactive'">
                {{ room.isActive ? 'Active' : 'Inactive' }}
              </p>
            </div>
          </div>
        </div>

        <!-- Medical Information Card -->
        <div class="info-card" *ngIf="appointment.medicine || appointment.notes">
          <div class="card-header">
            <h2><i class="fas fa-file-medical"></i> Medical Information</h2>
          </div>
          <div class="card-body row">
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="appointment.medicine">
              <label><i class="fas fa-pills"></i> Medicine Prescribed</label>
              <p>{{ appointment.medicine }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="appointment.notes">
              <label><i class="fas fa-sticky-note"></i> Treatment Notes</label>
              <p>{{ appointment.notes }}</p>
            </div>
          </div>
        </div>
        <!-- Appointment Information Card -->
        <div class="info-card">
          <div class="card-header">
            <h2><i class="fas fa-calendar-alt"></i> Appointment Information</h2>
          </div>
          <div class="card-body row">
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-id-card"></i> Appointment ID</label>
              <p>#{{ appointment.appointmentId }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-calendar-day"></i> Date</label>
              <p>{{ appointment.formattedDate }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-clock"></i> Time</label>
              <p>{{ appointment.formattedTime }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-info-circle"></i> Status</label>
              <p [style.color]="appointment.statusColor">{{ appointment.status }}</p>
            </div>
          </div>
        </div>


        <!-- Feedback Card -->
        <div class="info-card" *ngIf="feedback">
          <div class="card-header">
            <h2><i class="fas fa-comment-dots"></i> Patient Feedback</h2>
          </div>
          <div class="card-body">
            <div class="feedback-rating">
              <label>Rating</label>
              <div class="stars mt-3">
                <i *ngFor="let star of [1,2,3,4,5]" 
                   [class]="star <= feedback.rate ? 'fas fa-star' : 'far fa-star'"
                   class="fa-beat"></i>
                <span class="rating-value">{{ feedback.rate }}/5</span>
              </div>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-comment"></i> Comment</label>
              <p class="feedback-comment">{{ feedback.comment }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4">
              <label><i class="fas fa-calendar"></i> Feedback Date</label>
              <p>{{ feedback.formattedFeedbackDate }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="feedback.doctorReply">
              <label><i class="fas fa-user-md"></i> Doctor Reply</label>
              <p class="doctor-reply">{{ feedback.doctorReply }}</p>
              <p class="reply-date">Replied on: {{ feedback.formattedReplyDate }}</p>
            </div>
            <div class="detail-item col-sm-6 col-md-6 col-lg-4" *ngIf="feedback.isFavourite">
              <label><i class="fas fa-star"></i> Favourite</label>
              <p>This feedback is marked as favourite</p>
            </div>
          </div>
        </div>

        <!-- No Feedback Message -->
        <div class="info-card" *ngIf="!feedback && appointment.status === 'Completed'">
          <div class="card-header">
            <h2><i class="fas fa-comment-dots"></i> Patient Feedback</h2>
          </div>
          <div class="card-body">
            <p class="no-data">No feedback available for this appointment yet.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Close Appointment Modal -->
<div class="modal-overlay" *ngIf="showCloseModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Close Appointment</h2>
      <button class="close-btn" (click)="closeModals()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="appointment-summary" *ngIf="appointment">
        <h4>Appointment Details:</h4>
        <p><strong>Patient:</strong> {{ appointment.patientName }}</p>
        <p><strong>Doctor:</strong> {{ appointment.doctorName }}</p>
        <p><strong>Date:</strong> {{ appointment.formattedDate }} at {{ appointment.formattedTime }}</p>
      </div>
      
      <div class="form-group">
        <label for="closeMedicine">Medicine Prescribed</label>
        <textarea 
          id="closeMedicine"
          [(ngModel)]="closeMedicine" 
          class="form-control" 
          placeholder="Enter medicines prescribed..."
          rows="3"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="closeNotes">Treatment Notes</label>
        <textarea 
          id="closeNotes"
          [(ngModel)]="closeNotes" 
          class="form-control" 
          placeholder="Enter treatment notes and observations..."
          rows="4"
        ></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeModals()">Cancel</button>
      <button class="btn-save" (click)="onCloseAppointment()" [disabled]="isLoading">
        <i class="fas fa-check-circle" *ngIf="!isLoading"></i>
        <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
        {{ isLoading ? 'Closing...' : 'Close Appointment' }}
      </button>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<app-confirmation-modal
  [isVisible]="showConfirmationModal"
  [title]="confirmationConfig.title"
  [message]="confirmationConfig.message"
  [icon]="confirmationConfig.icon"
  [iconColor]="confirmationConfig.iconColor"
  [confirmText]="confirmationConfig.confirmText"
  [cancelText]="confirmationConfig.cancelText"
  [confirmButtonClass]="confirmationConfig.confirmButtonClass"
  (confirm)="onConfirmAction()"
  (cancel)="onCancelAction()">
</app-confirmation-modal>

