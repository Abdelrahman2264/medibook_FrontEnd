<div class="book-appointment-page">
  <div class="page-header">
    <h1>Book New Appointment</h1>
    <button class="btn-back" (click)="router.navigate(['/appointments'])">
      <i class="fas fa-arrow-left"></i> Back to Appointments
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="doctorsLoading && doctors.length === 0" class="loading-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin fa-3x"></i>
      <p>Loading doctors...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage && !doctorsLoading" class="error-message">
    <i class="fas fa-exclamation-circle"></i>
    {{ errorMessage }}
  </div>

  <!-- Doctors Grid -->
  <div class="doctors-grid" *ngIf="doctors.length > 0">
    <div class="doctor-card" *ngFor="let doctor of doctors">
      <div class="doctor-image">
        <img
          [src]="getDoctorImageUrl(doctor.photoUrl)"
          [alt]="doctor.fullName"
          (error)="handleDoctorImageError($event)"
        >
      </div>
      <div class="doctor-info">
        <h3>{{ doctor.fullName }}</h3>
        <p class="specialization">{{ doctor.specialization }}</p>
        <p class="type">{{ doctor.type }}</p>
        <p class="experience">{{ doctor.experienceYears }} years experience</p>
        <p class="bio">{{ doctor.bio }}</p>
      </div>
      <div class="doctor-actions">
        <button class="btn-profile" (click)="viewDoctorProfile(doctor)">
          <i class="fas fa-user-md"></i> View Profile
        </button>
        <button class="btn-book" (click)="bookAppointment(doctor)">
          <i class="fas fa-calendar-plus"></i> Book Appointment
        </button>
      </div>
    </div>
  </div>

  <!-- No Doctors Message -->
  <div *ngIf="!doctorsLoading && doctors.length === 0 && !errorMessage" class="no-data-message">
    <i class="fas fa-user-md fa-3x"></i>
    <h3>No Doctors Available</h3>
    <p>There are currently no doctors available for booking.</p>
  </div>

  <!-- Booking Modal -->
  <div class="modal-overlay" *ngIf="showBookingModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Book Appointment with Dr. {{ selectedDoctor?.fullName }}</h2>
        <button class="close-btn" (click)="closeModal()">&times;</button>
      </div>
      
      <div class="modal-body">
        <!-- Loading indicator for available dates -->
        <div class="inline-loading" *ngIf="availableDatesLoading">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Loading available dates for current month...</span>
        </div>

        <!-- Info message about current month only -->
        <div class="info-message" *ngIf="!availableDatesLoading">
          <i class="fas fa-info-circle"></i>
          <p>Note: You can only book appointments for the current month. Available dates are highlighted in blue.</p>
        </div>

        <!-- Calendar Section -->
        <div class="calendar-section" *ngIf="!availableDatesLoading">
          <div class="calendar-header">
            <div class="calendar-navigation">
              <button class="nav-btn disabled" (click)="prevMonth()" title="Only current month available" disabled>
                <i class="fas fa-chevron-left"></i>
              </button>
              <div class="current-month">
                <h3>{{ getCurrentMonthYear() }}</h3>
                <button class="today-btn" (click)="goToToday()">Today</button>
              </div>
              <button class="nav-btn disabled" (click)="nextMonth()" title="Only current month available" disabled>
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>

          <!-- Days of Week -->
          <div class="days-of-week">
            <div class="day-header" *ngFor="let day of daysOfWeek">{{ day }}</div>
          </div>

          <!-- Calendar Grid -->
          <div class="calendar-grid">
            <div 
              class="calendar-day" 
              *ngFor="let day of calendarDays"
              [class.current-month]="day.isCurrentMonth"
              [class.not-current-month]="!day.isCurrentMonth"
              [class.today]="day.isToday"
              [class.selected]="day.isSelected"
              [class.available]="day.isAvailable"
              [class.past]="day.isPast"
              (click)="selectDate(day)"
            >
              <div class="day-number">{{ day.date.getDate() }}</div>
              <div class="day-indicators">
                <i class="fas fa-circle" *ngIf="day.isToday"></i>
                <i class="fas fa-check-circle" *ngIf="day.isSelected"></i>
              </div>
              <div class="day-status">
                <span class="status-available" *ngIf="day.isAvailable && day.isCurrentMonth && !day.isPast">
                  Available
                </span>
                <span class="status-past" *ngIf="day.isPast">Past</span>
                <span class="status-other-month" *ngIf="!day.isCurrentMonth">
                  {{ day.isPast ? 'Past' : 'Future' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Selected Date -->
        <div class="selected-date-section" *ngIf="selectedDate">
          <div class="selected-date-display">
            <i class="fas fa-calendar-day"></i>
            <span><strong>Selected Date:</strong> {{ selectedDate | date:'fullDate' }}</span>
          </div>
        </div>

        <!-- Time Slots Grid -->
        <div class="time-slots-section" *ngIf="selectedDate && getAvailableSlotsForSelectedDate().length > 0">
          <h4>Select Time Slot</h4>
          <div class="time-slots-grid">
            <div 
              class="time-slot" 
              *ngFor="let slot of getAvailableSlotsForSelectedDate()"
              [class.selected]="selectedTime === slot"
              (click)="selectTime(slot)"
            >
              <i class="fas fa-clock"></i>
              <span>{{ slot }}</span>
            </div>
          </div>
        </div>

        <!-- No Slots Available -->
        <div class="no-slots-message" *ngIf="selectedDate && getAvailableSlotsForSelectedDate().length === 0">
          <i class="fas fa-calendar-times"></i>
          <p>No available time slots for this date. Please select another date.</p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModal()">Cancel</button>
        <button 
          class="btn-confirm" 
          (click)="confirmBooking()" 
          [disabled]="!selectedDate || !selectedTime || bookingInProgress"
        >
          <i class="fas fa-calendar-check" *ngIf="!bookingInProgress"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="bookingInProgress"></i>
          {{ bookingInProgress ? 'Booking...' : 'Confirm Booking' }}
        </button>
      </div>
    </div>
  </div>
</div>