<div class="appointments-page-container">
  <div class="main-content">
    <div class="appointment-list-page">
      <div class="page-title-bar">
        <h1 class="page-title">Appointments Management</h1>
        <button class="add-appointment-btn" (click)="navigateToBookAppointment()">
          <i class="fas fa-plus"></i> Book New Appointment
        </button>
      </div>

      <div class="top-cards-container">
        <div class="top-card light-purple">
          <h3>Total Appointments</h3>
          <p>{{ appointments.length }}</p>
        </div>
        <div class="top-card light-blue">
          <h3>Scheduled</h3>
          <p>{{ countScheduled() }}</p>
        </div>
        <div class="top-card light-orange">
          <h3>In Progress</h3>
          <p>{{ countInProgress() }}</p>
        </div>
        <div class="top-card light-green">
          <h3>Completed</h3>
          <p>{{ countCompleted() }}</p>
        </div>
      </div>

      <div class="search-container">
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          placeholder="Search by patient or doctor name..." 
          class="search-input" 
          (input)="forceUpdate()"
        />
        <i class="fa fa-search search-icon"></i>
      </div>

      <div class="controls">
        <select [(ngModel)]="selectedStatus" class="filter-select" (change)="forceUpdate()">
          <option value="">Filter by Status</option>
          <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
        </select>

        <select [(ngModel)]="selectedDoctor" class="filter-select" (change)="forceUpdate()">
          <option value="">Filter by Doctor</option>
          <option *ngFor="let doctor of doctors" [value]="doctor.fullName">{{ doctor.fullName }}</option>
        </select>

        <button (click)="clearAllFilters()" class="clear-all-btn">
          Clear All <i class="fas fa-times-circle"></i>
        </button>
      </div>

      <div *ngIf="isLoading && appointments.length === 0" class="loading-container">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin fa-3x"></i>
          <p>Loading appointments...</p>
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>

      <div *ngIf="errorMessage && !isLoading" class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        {{ errorMessage }}
        <button (click)="loadAppointments()" class="btn btn-retry" style="margin-left: 10px;">
          <i class="fas fa-redo"></i> Retry
        </button>
      </div>

      <div class="results-bar" *ngIf="!isLoading && appointments.length > 0">
        <div class="results-info">
          <i class="fas fa-calendar-check"></i>
          Showing <span class="highlight">{{filteredAppointments().length}}</span> of 
          <span class="total">{{appointments.length}}</span> appointments
        </div>
      </div>
      
      <div *ngIf="!isLoading && appointments.length === 0" class="empty-state">
        <div class="empty-state-content">
          <i class="fas fa-calendar-times fa-4x"></i>
          <h2>No Appointments Found</h2>
          <p>There are no appointments scheduled yet.</p>
          <button class="add-appointment-btn" (click)="navigateToBookAppointment()">
            <i class="fas fa-plus"></i> Schedule First Appointment
          </button>
        </div>
      </div>

      <div class="cards-container" *ngIf="!isLoading && appointments.length > 0">
        <div
          class="appointment-card "
          *ngFor="let appointment of filteredAppointments(); let i = index"
          [style.background-color]="getCardColor(appointment.status, i)"
        >
          <button 
            class="appointment-header" 
            (click)="toggleCard(appointment)"
            [attr.aria-expanded]="appointment.isExpanded"
            [attr.aria-controls]="'collapse' + appointment.appointmentId"
          >
            <div class="header-main-info">
                <p class="patient-name"><i class="fas fa-user-injured" style="margin-right: 5px; "></i> {{ appointment.patientName }}</p>
                <p class="doctor-name">Dr. {{ appointment.doctorName }}</p>
            </div>
            
            <div class="header-right-info">
                <p class="appointment-datetime">
                    <i class="fas fa-calendar-day"></i> {{ appointment.formattedDate }}
                    <i class="fas fa-clock" style="margin-left: 10px;"></i> {{ appointment.formattedTime }}
                </p>

                <div class="status-badge" [style.background-color]="appointment.statusColor">
                  <i [class]="appointment.statusIcon"></i>
                  {{ appointment.status }}
                </div>
            </div>

            <i class="fas fa-chevron-down accordion-icon" [ngClass]="{'expanded': appointment.isExpanded}"></i>

          </button>
          
          <div 
            [id]="'collapse' + appointment.appointmentId" 
            [class.expanded-content]="appointment.isExpanded"
            class="appointment-info-wrapper"
          >
            <div class="appointment-info-content"> 
                <div class="appointment-info">
                    <div class="info-section">
                        <h3><i class="fas fa-user-injured"></i> Patient Details</h3>
                        <p class="patient-details">Patient Info: {{ appointment.patientInfo }}</p>
                    </div>

                    <div class="info-section">
                        <h3><i class="fas fa-user-md"></i> Doctor Details</h3>
                        <p class="doctor-specialty">Specialty: {{ appointment.doctorSpecialization }}</p>
                    </div>

                    <div class="info-section color-gray" *ngIf="appointment.nurseId || appointment.roomId">
                        <h3><i class="fas fa-clipboard-list"></i> Assignment</h3>
                        <p *ngIf="appointment.nurseId">
                        <i class="fas fa-xs fa-user-nurse"></i> Nurse: {{ appointment.nurseName }}
                        </p>
                        <p *ngIf="appointment.roomId">
                        <i class="fas fa-xs fa-door-open"></i> Room: {{ appointment.roomName }}
                        </p>
                    </div>

                    <div class="info-section" *ngIf="appointment.medicine || appointment.notes">
                        <h3><i class="fas fa-file-medical"></i> Medical Info</h3>
                        <p *ngIf="appointment.medicine" class="medicine">
                        <i class="fas fa-pills"></i> Medicine: {{ appointment.medicine }}
                        </p>
                        <p *ngIf="appointment.notes" class="notes">
                        <i class="fas fa-sticky-note"></i> Notes: {{ appointment.notes }}
                        </p>
                    </div>
                </div>

                <div class="appointment-actions">
                    <button 
                    *ngIf="!appointment.nurseId && !appointment.roomId && appointment.status === 'Scheduled'"
                    class="assign-btn" 
                    (click)="navigateToAssign(appointment)">
                    <i class="fas fa-user-nurse"></i> Assign
                    </button>

                    <button 
                    *ngIf="(appointment.status === 'In Progress' || appointment.status === 'Assigned') && appointment.nurseId && appointment.roomId"
                    class="close-btn" 
                    (click)="confirmClose(appointment)">
                    <i class="fas fa-check-circle"></i> Close
                    </button>

                    <button 
                    *ngIf="['Pending', 'Scheduled'].includes(appointment.status)"
                    class="cancel-btn" 
                    (click)="confirmCancel(appointment)">
                    <i class="fas fa-times-circle"></i> Cancel
                    </button>

                    <button 
                    *ngIf="appointment.status === 'Completed' && !hasFeedback(appointment.appointmentId)"
                    class="feedback-btn" 
                    (click)="openFeedbackModal(appointment)">
                    <i class="fas fa-comment-dots"></i> Add Feedback
                    </button>

                    <button class="view-btn" (click)="navigateToDetails(appointment)">
                    <i class="fas fa-eye"></i> Details
                    </button>
                </div>
            </div>
          </div>
        </div>
      </div>

      
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showCancelModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Cancel Appointment</h2>
        <button class="close-btn" (click)="closeModals()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="appointment-summary">
          <h4>Appointment Details:</h4>
          <p><strong>Patient:</strong> {{ selectedAppointment?.patientName }}</p>
          <p><strong>Doctor:</strong> {{ selectedAppointment?.doctorName }}</p>
          <p><strong>Date:</strong> {{ selectedAppointment?.formattedDate }} at {{ selectedAppointment?.formattedTime }}</p>
        </div>
        
        <div class="form-group">
          <label for="cancelReason">Cancellation Reason <span class="required">*</span></label>
          <textarea 
            id="cancelReason"
            [(ngModel)]="cancelReason" 
            class="form-control" 
            placeholder="Please provide the reason for cancellation..."
            rows="4"
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModals()">Cancel</button>
        <button class="btn-save" (click)="onCancelAppointment()" [disabled]="!cancelReason.trim() || isLoading">
          <i class="fas fa-times-circle" *ngIf="!isLoading"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
          {{ isLoading ? 'Canceling...' : 'Confirm Cancellation' }}
        </button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showCloseModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Close Appointment</h2>
        <button class="close-btn" (click)="closeModals()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="appointment-summary">
          <h4>Appointment Details:</h4>
          <p><strong>Patient:</strong> {{ selectedAppointment?.patientName }}</p>
          <p><strong>Doctor:</strong> {{ selectedAppointment?.doctorName }}</p>
          <p><strong>Date:</strong> {{ selectedAppointment?.formattedDate }} at {{ selectedAppointment?.formattedTime }}</p>
        </div>
        
        <div class="form-group">
          <label for="closeMedicine">Medicine Prescribed</label>
          <textarea 
            id="closeMedicine"
            [(ngModel)]="closeMedicine" 
            class="form-control" 
            placeholder="Enter medicines prescribed..."
            rows="3"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="closeNotes">Treatment Notes</label>
          <textarea 
            id="closeNotes"
            [(ngModel)]="closeNotes" 
            class="form-control" 
            placeholder="Enter treatment notes and observations..."
            rows="4"
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModals()">Cancel</button>
        <button class="btn-save" (click)="onCloseAppointment()" [disabled]="isLoading">
          <i class="fas fa-check-circle" *ngIf="!isLoading"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
          {{ isLoading ? 'Closing...' : 'Close Appointment' }}
        </button>
      </div>
    </div>
  </div>

  <app-confirmation-modal
    [isVisible]="showConfirmationModal"
    [title]="confirmationConfig.title"
    [message]="confirmationConfig.message"
    [icon]="confirmationConfig.icon"
    [iconColor]="confirmationConfig.iconColor"
    [confirmText]="confirmationConfig.confirmText"
    [cancelText]="confirmationConfig.cancelText"
    [confirmButtonClass]="confirmationConfig.confirmButtonClass"
    (confirm)="onConfirmAction()"
    (cancel)="onCancelAction()">
  </app-confirmation-modal>

  <app-feedback-form-modal
    [isVisible]="showFeedbackModal"
    [appointment]="selectedAppointment"
    [isLoading]="isLoading"
    (close)="closeModals()"
    (save)="onCreateFeedback($event)">
  </app-feedback-form-modal>

</div>